# Integrating Qt into a Yocto Project

## 1. Prerequisites on Host Machine

Before working with Yocto and Qt, install the required Qt development packages on your host machine (for local testing and building tools):

```bash
sudo apt update
sudo apt install qtcreator qtbase5-dev qtbase5-dev-tools qtdeclarative5-dev \
qml-module-qtquick2 qml-module-qtquick-controls2 qt5-qmake cmake \
build-essential libgl1-mesa-dev
```

These packages allow you to:
- Edit and test Qt applications locally.
- Use `qmake` and Qt Creator.

---

## 2. Adding `meta-qt5` to the Yocto Project

### 2.1 Clone the meta-qt5 Layer

Inside your Yocto `sources` directory, clone the **meta-qt5** layer:

```bash
git clone -b scarthgap https://github.com/meta-qt5/meta-qt5.git
```

### 2.2 Add the Layer to bblayers.conf

```bash
bitbake-layers add-layer ../meta-qt5
```

---

## 3. Configuring local.conf

Open `conf/local.conf` and make the following changes:

```bash
# Enable Wayland and PAM in distro features
DISTRO_FEATURES:append = " wayland pam"

# Install essential networking and Qt packages in the target image
IMAGE_INSTALL:append = " wpa-supplicant networkmanager \
    qtbase qtdeclarative qtquickcontrols2 qtgraphicaleffects \
    weston qtwayland"

# Install the custom Qt application (defined later)
IMAGE_INSTALL:append = " qtapp"
```

---

## 4. Building the Image with Qt Support

Run:

```bash
bitbake core-image-base
```

---

## 5. Adding a Custom Qt Application to Yocto

- Create a Recipe Directory

```bash
mkdir -p meta-tdieney/recipes-apps/qtapp/files
```

- Copy your Qt application source files into `files/`

---

- Create the Recipe File `qtapp.bb`

```bitbake
SUMMARY = "Qt Quick Instrument Cluster Application"
DESCRIPTION = "A Qt Quick application for an instrument cluster"
LICENSE = "CLOSED"

SRC_URI = " \
    file://main.cpp \
    file://main.qml \
    file://qml.qrc \
    file://qtapp.pro \
    file://Images.qrc \
    file://Fonts.qrc \
    file://Configs.qrc \
    file://communication/canhandler.cpp \
    file://communication/canhandler.h \
    file://fonts/Aldrich-Regular.ttf \
    file://images/background.png \
    file://images/centre.png \
    file://images/arrow.png \
    file://images/high_beam.png \
    file://images/low_beam.png \
    file://images/parking_lights.png \
    file://images/hazard.png \
    file://images/left_arrow.png \
    file://images/right_arrow.png \
    file://io_configs/io_config.json \
"

S = "${WORKDIR}"
B = "${WORKDIR}/build"

DEPENDS += "qtbase qtdeclarative qtquickcontrols2 qtgraphicaleffects"

inherit qmake5

FILES_${PN} += "${bindir}/qtapp"

do_install() {
    install -d ${D}${bindir}
    install -m 0755 ${B}/qtapp ${D}${bindir}/
}
```

---

## 6. Building and Deploying the Application

1. Add your recipe to the image by ensuring itâ€™s listed in `local.conf`:

```bash
IMAGE_INSTALL:append = " qtapp"
```

2. Build the image:

```bash
bitbake core-image-base
```

3. Flash the generated image to your target board.

---

## 7. Running the Qt Application on Wayland

When your system boots, you can run:

```bash
cd /usr/bin/
export QT_QPA_PLATFORM=wayland
export XDG_RUNTIME_DIR=/tmp/runtime-root
./qtapp
```
