# Build image for Raspberry Pi 5

## Prerequisites

* OS: Ubuntu 20.04 or later (preferably 22.04)
* Packages:

```bash
sudo apt update
sudo apt install gawk wget git-core diffstat unzip texinfo gcc build-essential chrpath socat cpio python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev xterm python3-subunit mesa-common-dev zstd liblz4-tool
```

---

## Step 1: Setup Yocto (Scarthgap)

```bash
git clone -b scarthgap https://git.yoctoproject.org/poky
cd poky
```

---

## Step 2: Clone Meta Layers

```bash
git clone -b scarthgap https://github.com/openembedded/meta-openembedded.git
git clone -b scarthgap https://github.com/agherzan/meta-raspberrypi.git
```

---

## Step 3: Source Environment and Create Build Directory

```bash
source oe-init-build-env
```

This creates a `build/` folder and drops you into it.

---

## Step 4: Modify `conf/bblayers.conf`

Add the following layers:

```bash
BBLAYERS ?= " \
  ${TOPDIR}/../poky/meta \
  ${TOPDIR}/../poky/meta-poky \
  ${TOPDIR}/../poky/meta-yocto-bsp \
  ${TOPDIR}/../meta-openembedded/meta-oe \
  ${TOPDIR}/../meta-openembedded/meta-python \
  ${TOPDIR}/../meta-openembedded/meta-networking \
  ${TOPDIR}/../meta-raspberrypi \
"
```

Or you can use `bitbake-layers add-layer`:

```bash
bitbake-layers add-layer ../meta-openembedded/meta-oe
bitbake-layers add-layer ../meta-openembedded/meta-python
bitbake-layers add-layer ../meta-openembedded/meta-networking
bitbake-layers add-layer ../meta-raspberrypi
```

---

## Step 5: Modify `conf/local.conf`

Edit `build/conf/local.conf`:

```bash
MACHINE = "raspberrypi5"
INIT_MANAGER = "systemd"
LICENSE_FLAGS_ACCEPTED = "synaptics-killswitch"
EXTRA_IMAGE_FEATURES:append = " ssh-server-dropbear"
IMAGE_INSTALL:append = " wpa-supplicant"
```

---

## Step 6: Build the Image

To build a minimal core image:

```bash
bitbake core-image-minimal
```

Or for a full-featured image with package manager:

```bash
bitbake core-image-base
```

---

## Step 7: Flash Image to SD Card

After the build completes, the image will be here:

```bash
# image is located at build/tmp/deploy/images/raspberrypi5/
~/yocto/poky$ cp build/tmp/deploy/images/raspberrypi5/core-image-base-raspberrypi5.rootfs-20250620013625.wic.bz2 temp.wic.bz2
~/yocto/poky$ bzip2 -d temp.wic.bz2
```

To flash the image:

```bash
sudo umount /dev/sdb1
sudo umount /dev/sdb2
sudo wipefs -a /dev/sdb
sudo dd if=/dev/zero of=/dev/sdb bs=1M count=10
sudo dd if=temp.wic of=/dev/sdb bs=4M status=progress
sync

```

---

## Step 8: Boot Raspberry Pi 5

1. Insert SD card and power on.
2. Connect UART/HDMI and keyboard.
3. Login with:

   ```
   root (no password)
   ```

